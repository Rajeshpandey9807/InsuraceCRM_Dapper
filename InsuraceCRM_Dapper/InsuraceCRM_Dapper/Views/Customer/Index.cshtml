@model CustomerListViewModel
@{
    ViewData["Title"] = "Customers";
    var bulkErrors = ViewData["BulkUploadErrors"] as IList<string>;
    var rawImportErrors = TempData["CustomerImportErrors"] as string;
    var importErrorLines = rawImportErrors?
        .Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
    var followUpModalModel = new FollowUpFormViewModel();
}

<div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <h2 class="mb-0">Customers</h2>
    <div class="btn-group">
        <a asp-action="Index" class="btn btn-outline-secondary">Refresh</a>
        @if (Model.CanEdit)
        {
            <a asp-action="BulkAssign" class="btn btn-outline-primary">Bulk Assign</a>
        }
    </div>
</div>

@if (TempData["CustomerSuccess"] is string successMessage)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @successMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="alert alert-success d-none" role="alert" id="followUpSuccessBanner">
    <span id="followUpSuccessMessage"></span>
    <a href="#" id="followUpSuccessHistoryLink" class="alert-link ms-2 d-none" target="_blank" rel="noopener">View history</a>
</div>

@if (importErrorLines?.Length > 0)
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <strong>Some rows were skipped during the latest upload:</strong>
        <ul class="mb-0 mt-2 ps-3">
            @foreach (var line in importErrorLines)
            {
                <li>@line</li>
            }
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (Model.CanEdit)
{
    <div class="row g-3 mb-4">
        <div class="col-xl-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h4 class="card-title mb-3">Add Single Customer</h4>
                    <form asp-action="CreateInline" method="post" novalidate>
                        @Html.AntiForgeryToken()
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="NewCustomer.Name" class="form-label"></label>
                                <input asp-for="NewCustomer.Name" class="form-control" />
                                <span asp-validation-for="NewCustomer.Name" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="NewCustomer.MobileNumber" class="form-label"></label>
                                <input asp-for="NewCustomer.MobileNumber" class="form-control" />
                                <span asp-validation-for="NewCustomer.MobileNumber" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="NewCustomer.Location" class="form-label"></label>
                                <input asp-for="NewCustomer.Location" class="form-control" />
                                <span asp-validation-for="NewCustomer.Location" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="NewCustomer.InsuranceType" class="form-label"></label>
                                <input asp-for="NewCustomer.InsuranceType" class="form-control" />
                                <span asp-validation-for="NewCustomer.InsuranceType" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="NewCustomer.Income" class="form-label"></label>
                                <input asp-for="NewCustomer.Income" class="form-control" type="number" min="0" step="0.01" />
                                <span asp-validation-for="NewCustomer.Income" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="NewCustomer.SourceOfIncome" class="form-label"></label>
                                <input asp-for="NewCustomer.SourceOfIncome" class="form-control" />
                                <span asp-validation-for="NewCustomer.SourceOfIncome" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="NewCustomer.FamilyMembers" class="form-label"></label>
                                <input asp-for="NewCustomer.FamilyMembers" class="form-control" type="number" min="0" step="1" />
                                <span asp-validation-for="NewCustomer.FamilyMembers" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">Save Customer</button>
                            <a asp-action="Add" class="btn btn-outline-secondary">Advanced form</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h4 class="card-title mb-3">Bulk Upload Customers</h4>
                    <form asp-action="BulkUpload" method="post" enctype="multipart/form-data">
                        @Html.AntiForgeryToken()
                        <div class="mb-3">
                            <label for="bulkFile" class="form-label">Upload CSV or Excel file</label>
                            <input class="form-control" type="file" id="bulkFile" name="file" accept=".csv,.xlsx,.xls" required />
                            @Html.ValidationMessage("BulkUpload", null, new { @class = "text-danger d-block mt-1" })
                        </div>
                        <p class="text-muted small mb-3">
                            Required columns: <strong>Name</strong>, <strong>MobileNumber</strong>, <strong>Location</strong>.
                            Optional columns: InsuranceType, Income, SourceOfIncome, FamilyMembers.
                        </p>
                        <div class="mb-3">
                            <a asp-action="DownloadTemplate" class="btn btn-link px-0">Download sample template</a>
                        </div>
                        @if (bulkErrors?.Count > 0)
                        {
                            <div class="alert alert-warning small" role="alert">
                                <strong>Import issues detected:</strong>
                                <ul class="mb-0 mt-2 ps-3">
                                    @foreach (var error in bulkErrors)
                                    {
                                        <li>@error</li>
                                    }
                                </ul>
                            </div>
                        }
                        <button type="submit" class="btn btn-outline-primary">Upload Customers</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
}

<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Mobile</th>
                        <th>Location</th>
                        <th>Insurance Type</th>
                        <th>Income</th>
                        <th>Source of Income</th>
                        <th>Family Members</th>
                        <th>Assigned To</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var customer in Model.Customers)
                    {
                        <tr>
                            <td>@customer.Name</td>
                            <td>@customer.MobileNumber</td>
                            <td>@(string.IsNullOrWhiteSpace(customer.Location) ? "-" : customer.Location)</td>
                            <td>@(string.IsNullOrWhiteSpace(customer.InsuranceType) ? "-" : customer.InsuranceType)</td>
                            <td>
                                @(customer.Income.HasValue ? customer.Income.Value.ToString("N2") : "-")
                            </td>
                            <td>@(string.IsNullOrWhiteSpace(customer.SourceOfIncome) ? "-" : customer.SourceOfIncome)</td>
                            <td>@(customer.FamilyMembers?.ToString() ?? "-")</td>
                            <td>@(customer.AssignedEmployeeName ?? "Unassigned")</td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a asp-controller="FollowUp" asp-action="History" asp-route-customerId="@customer.Id" class="btn btn-info">History</a>
                                    <button type="button"
                                            class="btn btn-success"
                                            data-follow-up-button
                                            data-customer-id="@customer.Id"
                                            data-customer-name="@customer.Name"
                                            data-customer-mobile="@customer.MobileNumber"
                                            data-customer-location="@customer.Location"
                                            data-customer-insurance="@(customer.InsuranceType ?? string.Empty)"
                                            data-assigned-name="@(customer.AssignedEmployeeName ?? string.Empty)">
                                        Follow-Up
                                    </button>
                                    @if (Model.CanEdit)
                                    {
                                        <a asp-action="Edit" asp-route-id="@customer.Id" class="btn btn-secondary">Edit</a>
                                        <a asp-action="AssignCustomer" asp-route-customerId="@customer.Id" class="btn btn-warning">Assign</a>
                                        <form asp-action="Delete" asp-route-id="@customer.Id" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn btn-danger" onclick="return confirm('Delete @customer.Name? This action cannot be undone.');">Delete</button>
                                        </form>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@await Html.PartialAsync("_FollowUpModal", followUpModalModel)

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (() => {
            const modalElement = document.getElementById('followUpModal');
            const bootstrapModal = window.bootstrap && modalElement ? new window.bootstrap.Modal(modalElement) : null;
            if (!bootstrapModal) {
                return;
            }

            const form = document.getElementById('followUpForm');
            const buttons = document.querySelectorAll('[data-follow-up-button]');
            const customerNameInput = document.getElementById('followUpCustomerName');
            const customerMobileInput = document.getElementById('followUpCustomerMobile');
            const customerLocationInput = document.getElementById('followUpCustomerLocation');
            const assignedToInput = document.getElementById('followUpAssignedTo');
            const historyLink = document.getElementById('followUpHistoryLink');
            const hiddenCustomerId = document.getElementById('CustomerId');
            const insuranceTypeSelect = document.getElementById('InsuranceType');
            const budgetInput = document.getElementById('Budget');
            const existingPolicySelect = document.getElementById('HasExistingPolicy');
            const followUpDateInput = document.getElementById('FollowUpDate');
            const followUpStatusSelect = document.getElementById('FollowUpStatus');
            const followUpNoteInput = document.getElementById('FollowUpNote');
            const reminderDateInput = document.getElementById('NextReminderDateTime');
            const reminderRequiredSelect = document.getElementById('ReminderRequired');
            const reminderWrapper = modalElement.querySelector('[data-reminder-wrapper]');
            const convertedSelect = document.getElementById('IsConverted');
            const conversionReasonInput = document.getElementById('ConversionReason');
            const assignmentWarning = document.getElementById('followUpAssignmentWarning');
            const inlineError = document.getElementById('followUpErrorAlert');
            const inlineSuccess = document.getElementById('followUpInlineSuccess');
            const submitButton = form?.querySelector('[data-follow-up-submit]');
            const submitSpinner = form?.querySelector('[data-follow-up-spinner]');
            const successBanner = document.getElementById('followUpSuccessBanner');
            const successBannerMessage = document.getElementById('followUpSuccessMessage');
            const successBannerHistoryLink = document.getElementById('followUpSuccessHistoryLink');

            if (!form || !buttons.length || !hiddenCustomerId) {
                return;
            }

            const formatDateOnly = () => {
                const today = new Date();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `${today.getFullYear()}-${month}-${day}`;
            };

            const buildHistoryUrl = (customerId) => customerId ? `/FollowUp/History?customerId=${customerId}` : '#';

            const toggleReminderState = () => {
                const requiresReminder = reminderRequiredSelect.value === 'true';
                reminderDateInput.disabled = !requiresReminder;
                if (!requiresReminder) {
                    reminderDateInput.value = '';
                    reminderWrapper?.classList.add('opacity-50');
                } else {
                    reminderWrapper?.classList.remove('opacity-50');
                }
            };

            reminderRequiredSelect?.addEventListener('change', toggleReminderState);

            const resetFormState = () => {
                form.reset();
                inlineError.classList.add('d-none');
                inlineError.textContent = '';
                inlineSuccess.classList.add('d-none');
                inlineSuccess.textContent = '';
                followUpDateInput.value = formatDateOnly();
                followUpStatusSelect.value = '';
                followUpNoteInput.value = '';
                budgetInput.value = '';
                reminderRequiredSelect.value = 'false';
                reminderDateInput.value = '';
                convertedSelect.value = '';
                conversionReasonInput.value = '';
                toggleReminderState();
            };

            const populateModal = (button) => {
                resetFormState();
                const customerId = button.dataset.customerId ?? '';
                const historyUrl = buildHistoryUrl(customerId);
                hiddenCustomerId.value = customerId;
                customerNameInput.value = button.dataset.customerName ?? '';
                customerMobileInput.value = button.dataset.customerMobile ?? '';
                customerLocationInput.value = button.dataset.customerLocation ?? '';
                assignedToInput.value = button.dataset.assignedName || 'Unassigned';
                insuranceTypeSelect.value = button.dataset.customerInsurance ?? '';
                historyLink?.setAttribute('href', historyUrl);

                const isAssigned = Boolean(button.dataset.assignedName);
                assignmentWarning.classList.toggle('d-none', isAssigned);
            };

            const showError = (message) => {
                inlineError.textContent = message;
                inlineError.classList.remove('d-none');
            };

            const showSuccess = (message, historyUrl) => {
                inlineSuccess.textContent = message;
                inlineSuccess.classList.remove('d-none');

                if (successBanner && successBannerMessage) {
                    successBannerMessage.textContent = message;
                    successBanner.classList.remove('d-none');
                    if (historyUrl && successBannerHistoryLink) {
                        successBannerHistoryLink.classList.remove('d-none');
                        successBannerHistoryLink.setAttribute('href', historyUrl);
                    } else {
                        successBannerHistoryLink?.classList.add('d-none');
                    }
                }
            };

            buttons.forEach((button) => {
                button.addEventListener('click', () => {
                    populateModal(button);
                    bootstrapModal.show();
                });
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                inlineError.classList.add('d-none');
                inlineError.textContent = '';
                inlineSuccess.classList.add('d-none');
                inlineSuccess.textContent = '';

                submitButton.disabled = true;
                submitSpinner?.classList.remove('d-none');

                try {
                    const response = await fetch(form.action, {
                        method: 'POST',
                        body: new FormData(form),
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    if (!response.ok) {
                        let errorMessage = 'Unable to save follow-up.';
                        if (response.status === 400) {
                            const payload = await response.json().catch(() => null);
                            if (payload?.errors?.length) {
                                errorMessage = payload.errors.join(' ');
                            } else if (payload?.message) {
                                errorMessage = payload.message;
                            }
                        } else if (response.status === 403) {
                            errorMessage = "You don't have permission to update this customer.";
                        } else if (response.status === 404) {
                            errorMessage = 'Customer not found.';
                        }

                        showError(errorMessage);
                        return;
                    }

                    const payload = await response.json().catch(() => ({}));
                    const message = payload?.message ?? 'Follow-up saved.';
                    const historyUrl = payload?.historyUrl ?? historyLink?.getAttribute('href');

                    showSuccess(message, historyUrl);
                    historyLink?.setAttribute('href', historyUrl ?? '#');

                    setTimeout(() => {
                        bootstrapModal.hide();
                    }, 800);
                } catch (error) {
                    showError('Something went wrong while saving. Please try again.');
                } finally {
                    submitButton.disabled = false;
                    submitSpinner?.classList.add('d-none');
                }
            });
        })();
    </script>
}
