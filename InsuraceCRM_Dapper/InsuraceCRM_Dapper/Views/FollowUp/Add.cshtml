@model FollowUpFormViewModel
@{
    ViewData["Title"] = "Add Follow-up";
    var insuranceTypes = new[] { "Life", "Health", "Term", "ULIP" };
    var callStatuses = new[] { "Interested", "Call Back Later", "Not Interested", "Not Reachable", "Number Switched Off" };
    var showNextFollowUp = string.Equals(Model.FollowUpStatus, "Interested", System.StringComparison.OrdinalIgnoreCase);
    var hasSalesDetails = Model?.IsConverted == true && (!string.IsNullOrWhiteSpace(Model.SoldProductName) ||
        Model.TicketSize.HasValue || Model.TenureInYears.HasValue || !string.IsNullOrWhiteSpace(Model.PolicyNumber) || Model.PolicyEnforceDate.HasValue);
}

<div class="row justify-content-center">
    <div class="col-lg-10 col-xl-9">
        <div class="card shadow-sm">
            <div class="card-body">
                <h4 class="card-title mb-1">Add Follow-up - @Model.CustomerName</h4>
                <p class="text-muted mb-4">Complete each section to capture a full view of the conversation.</p>
                <form asp-action="Add" method="post" data-followup-form="true">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="CustomerId" />
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="border rounded-3 p-4 mb-4">
                        <h6 class="text-uppercase text-muted fw-semibold mb-3">1. Basic Customer Info</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Customer Name</label>
                                <input class="form-control" value="@Model.CustomerName" readonly />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Mobile No</label>
                                <input class="form-control" value="@Model.CustomerMobileNumber" readonly />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Location</label>
                                <input class="form-control" value="@Model.CustomerLocation" readonly />
                            </div>
                        </div>
                    </div>

                    <div class="border rounded-3 p-4 mb-4">
                        <h6 class="text-uppercase text-muted fw-semibold mb-3">2. Insurance Requirement</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="InsuranceType" class="form-label"></label>
                                <select asp-for="InsuranceType" class="form-select">
                                    <option value="">Select insurance type</option>
                                    @foreach (var type in insuranceTypes)
                                    {
                                        var isSelected = string.Equals(Model.InsuranceType, type, System.StringComparison.OrdinalIgnoreCase) ? "selected" : null;
                                        <option value="@type" selected="@isSelected">@type</option>
                                    }
                                </select>
                                <span asp-validation-for="InsuranceType" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="Budget" class="form-label"></label>
                                <input asp-for="Budget" class="form-control" type="number" step="0.01" min="0" />
                                <span asp-validation-for="Budget" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="HasExistingPolicy" class="form-label"></label>
                                <select asp-for="HasExistingPolicy" class="form-select">
                                    <option value="true" selected="@(Model.HasExistingPolicy ? "selected" : null)">Yes</option>
                                    <option value="false" selected="@(Model.HasExistingPolicy ? null : "selected")">No</option>
                                </select>
                                <span asp-validation-for="HasExistingPolicy" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="border rounded-3 p-4 mb-4">
                        <h6 class="text-uppercase text-muted fw-semibold mb-3">3. Call Follow-Up Details</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="FollowUpDate" class="form-label"></label>
                                <input asp-for="FollowUpDate" class="form-control" type="date" />
                                <span asp-validation-for="FollowUpDate" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="FollowUpStatus" class="form-label"></label>
                                <select asp-for="FollowUpStatus" class="form-select">
                                    <option value="">Select call status</option>
                                    @foreach (var status in callStatuses)
                                    {
                                        var isSelected = string.Equals(Model.FollowUpStatus, status, System.StringComparison.OrdinalIgnoreCase) ? "selected" : null;
                                        <option value="@status" selected="@isSelected">@status</option>
                                    }
                                </select>
                                <span asp-validation-for="FollowUpStatus" class="text-danger"></span>
                            </div>
                            <div class="col-12">
                                <label asp-for="FollowUpNote" class="form-label"></label>
                                <textarea asp-for="FollowUpNote" class="form-control" rows="4" placeholder="Capture the key discussion points..."></textarea>
                                <span asp-validation-for="FollowUpNote" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div id="nextFollowUpSection" class="border rounded-3 p-4 mb-4 @(showNextFollowUp ? string.Empty : "d-none")">
                        <h6 class="text-uppercase text-muted fw-semibold mb-3">4. Next Follow-Up</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="NextReminderDateTime" class="form-label"></label>
                                <input asp-for="NextReminderDateTime" class="form-control" type="datetime-local" asp-format="{0:yyyy-MM-ddTHH:mm}" />
                                <span asp-validation-for="NextReminderDateTime" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="ReminderRequired" class="form-label"></label>
                                <select asp-for="ReminderRequired" class="form-select">
                                    <option value="true" selected="@(Model.ReminderRequired ? "selected" : null)">Yes</option>
                                    <option value="false" selected="@(Model.ReminderRequired ? null : "selected")">No</option>
                                </select>
                                <span asp-validation-for="ReminderRequired" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="border rounded-3 p-4 mb-4">
                        <h6 class="text-uppercase text-muted fw-semibold mb-3">5. Final Status</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="IsConverted" class="form-label"></label>
                                <select asp-for="IsConverted" class="form-select">
                                    <option value="" selected="@(Model.IsConverted is null ? "selected" : null)">Not decided</option>
                                    <option value="true" selected="@(Model.IsConverted == true ? "selected" : null)">Yes</option>
                                    <option value="false" selected="@(Model.IsConverted == false ? "selected" : null)">No</option>
                                </select>
                                <span asp-validation-for="IsConverted" class="text-danger"></span>
                            </div>
                            <div class="col-12">
                                <label asp-for="ConversionReason" class="form-label"></label>
                                <textarea asp-for="ConversionReason" class="form-control" rows="3" placeholder="Capture the reason if the deal did not convert."></textarea>
                                <span asp-validation-for="ConversionReason" class="text-danger"></span>
                            </div>
                            <div class="col-12">
                                <div class="d-flex flex-wrap gap-2 align-items-center">
                                    <button type="button" class="btn btn-outline-primary d-none" data-action="open-sales-modal">
                                        <span data-sales-button-text="true">Add Sold Product Details</span>
                                    </button>
                                    <small class="text-muted" data-sales-hint="true">Provide sale details when the deal is marked as converted.</small>
                                </div>
                                <div id="salesDetailsSummary" class="alert alert-info mt-3 @(hasSalesDetails ? string.Empty : "d-none")">
                                    <div><strong>Product:</strong> <span data-sales-summary="product">@(Model.SoldProductName ?? "-")</span></div>
                                    <div><strong>Ticket Size:</strong> <span data-sales-summary="ticket">@(Model.TicketSize.HasValue ? Model.TicketSize.Value.ToString("N2") : "-")</span></div>
                                    <div><strong>Tenure (years):</strong> <span data-sales-summary="tenure">@(Model.TenureInYears?.ToString() ?? "-")</span></div>
                                    <div><strong>Policy #:</strong> <span data-sales-summary="policyNumber">@(Model.PolicyNumber ?? "-")</span></div>
                                    <div><strong>Enforce Date:</strong> <span data-sales-summary="policyDate">@(Model.PolicyEnforceDate?.ToString("yyyy-MM-dd") ?? "-")</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="modal fade" id="soldProductModal" tabindex="-1" aria-labelledby="soldProductModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="soldProductModalLabel">Sold Product Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label asp-for="SoldProductId" class="form-label"></label>
                                            <select asp-for="SoldProductId" class="form-select" asp-items="Model.ProductOptions" data-sales-required="true">
                                                <option value="">Select a product</option>
                                            </select>
                                            <span asp-validation-for="SoldProductId" class="text-danger"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <label asp-for="TicketSize" class="form-label"></label>
                                            <input asp-for="TicketSize" class="form-control" type="number" step="0.01" min="0" data-sales-required="true" />
                                            <span asp-validation-for="TicketSize" class="text-danger"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <label asp-for="TenureInYears" class="form-label"></label>
                                            <select asp-for="TenureInYears" class="form-select" data-sales-required="true">
                                                <option value="">Select tenure</option>
                                                @for (var tenure = 1; tenure <= 5; tenure++)
                                                {
                                                    <option value="@tenure" selected="@(Model.TenureInYears == tenure ? "selected" : null)">@tenure year@(tenure == 1 ? "" : "s")</option>
                                                }
                                            </select>
                                            <span asp-validation-for="TenureInYears" class="text-danger"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <label asp-for="PolicyNumber" class="form-label"></label>
                                            <input asp-for="PolicyNumber" class="form-control" data-sales-required="true" />
                                            <span asp-validation-for="PolicyNumber" class="text-danger"></span>
                                        </div>
                                        <div class="col-md-6">
                                            <label asp-for="PolicyEnforceDate" class="form-label"></label>
                                            <input asp-for="PolicyEnforceDate" class="form-control" type="date" data-sales-required="true" />
                                            <span asp-validation-for="PolicyEnforceDate" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-outline-secondary" data-action="cancel-sales-modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" data-action="save-sales-modal">Save Details</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Save Follow-up</button>
                        <a asp-controller="Customer" asp-action="Index" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/followup-form.js" asp-append-version="true"></script>
}
