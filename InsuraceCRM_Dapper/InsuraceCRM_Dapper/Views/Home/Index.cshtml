@model InsuraceCRM_Dapper.ViewModels.DashboardViewModel
@using InsuraceCRM_Dapper.ViewModels
@using System.Linq
@using System.Collections.Generic

@{
    ViewData["Title"] = "Dashboard";

    var reminders = Model?.TodaysReminders?
        .OrderBy(r => r.ReminderDateTime)
        .Take(5)
        .ToList() ?? new List<ReminderViewModel>();

    var assignedCustomers = Model?.AssignedCustomerCount ?? 0;
    var todaysCalls = Model?.TodaysCallCount ?? 0;
    var todaysReminders = Model?.TodaysReminderCount ?? reminders.Count;
    var completionRate = todaysReminders == 0
        ? 0
        : (int)Math.Round(Math.Min(100, (double)todaysCalls / todaysReminders * 100));
    var pendingReminders = Math.Max(0, todaysReminders - todaysCalls);
}

<div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
    <div>
        <h2 class="mb-1">Dashboard</h2>
        <p class="text-muted mb-0">Track assigned customers, sales calls, and reminders in one place.</p>
    </div>
    <div class="text-end">
        <div class="text-muted small">Last refreshed @DateTime.UtcNow.ToLocalTime():MMM d, yyyy h:mm tt</div>
        <div class="btn-group mt-2" role="group">
            <a asp-action="Index" class="btn btn-sm btn-outline-secondary">Refresh</a>
            <a asp-controller="Reminder" asp-action="Today" class="btn btn-sm btn-primary">Add Reminder</a>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-6 col-xl-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-uppercase text-muted small">Assigned customers</span>
                    <span class="badge bg-light text-dark">Live</span>
                </div>
                <h3 class="display-6 fw-semibold mb-0">@assignedCustomers</h3>
                <p class="text-muted small mb-3">Active customers currently assigned across the team.</p>
                <a asp-controller="Customer" asp-action="Index" class="btn btn-sm btn-outline-primary">View customers</a>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-uppercase text-muted small">Sales calls today</span>
                    <span class="badge bg-success">@todaysCalls</span>
                </div>
                <h3 class="display-6 fw-semibold mb-0">@todaysCalls</h3>
                <p class="text-muted small mb-3">Follow-ups and sales conversations logged so far today.</p>
                <div class="progress" role="progressbar" aria-label="Sales progress" aria-valuenow="@Math.Min(100, todaysCalls * 5)" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar bg-success" style="width: @Math.Min(100, todaysCalls * 5)%"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-uppercase text-muted small">Today's reminders</span>
                    <span class="badge bg-warning text-dark">@todaysReminders planned</span>
                </div>
                <h3 class="display-6 fw-semibold mb-0">@todaysReminders</h3>
                <p class="text-muted small mb-3">Reminders that still need attention before end of day.</p>
                <div class="d-flex justify-content-between text-muted small">
                    <span>Pending</span>
                    <strong>@pendingReminders</strong>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-uppercase text-muted small">Reminder completion</span>
                    <span class="badge bg-info text-dark">@completionRate%</span>
                </div>
                <h3 class="display-6 fw-semibold mb-1">@completionRate%</h3>
                <p class="text-muted small mb-3">Share of planned reminders already covered by calls.</p>
                <div class="progress" role="progressbar" aria-label="Reminder completion" aria-valuenow="@completionRate" aria-valuemin="0" aria-valuemax="100">
                    <div class="progress-bar bg-info" style="width: @completionRate%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3">
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Sales report</h5>
                    <span class="badge bg-light text-dark">Today</span>
                </div>
                <p class="text-muted small mb-4">Snapshot of how todayâ€™s calls stack up against scheduled reminders.</p>

                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span>Planned customer touches</span>
                        <strong>@todaysReminders</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span>Sales / follow-up calls logged</span>
                        <strong>@todaysCalls</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                        <span>Remaining reminders</span>
                        <strong>@pendingReminders</strong>
                    </li>
                </ul>

                <div class="mt-4">
                    <div class="d-flex justify-content-between text-muted small mb-1">
                        <span>Completion toward plan</span>
                        <strong>@completionRate%</strong>
                    </div>
                    <div class="progress" role="progressbar" aria-valuenow="@completionRate" aria-valuemin="0" aria-valuemax="100">
                        <div class="progress-bar bg-primary" style="width: @completionRate%"></div>
                    </div>
                </div>

                <div class="alert alert-info mt-4 mb-0" role="alert">
                    Keep logging every interaction so the team can see real-time sales momentum.
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Today's reminders</h5>
                    <a asp-controller="Reminder" asp-action="Today" class="btn btn-sm btn-outline-secondary">Manage reminders</a>
                </div>
                <p class="text-muted small mb-3">The next few conversations that need attention.</p>

                @if (reminders.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-sm align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Time</th>
                                    <th>Notes</th>
                                    <th class="text-end">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var reminder in reminders)
                                {
                                    <tr class="transition duration-200 hover:bg-white/5">
                                        <td class="px-4 py-4">
                                            <div class="flex items-center gap-3">
                                                <div class="h-10 w-10 rounded-2xl border border-white/10 bg-white/5"></div>
                                                <div>
                                                    <p class="font-semibold">@reminder.CustomerName</p>
                                                    <p class="text-xs text-white/50">
                                                        @(string.IsNullOrWhiteSpace(reminder.CustomerMobileNumber)
                                                                                                        ? $"Customer #{reminder.CustomerId}"
                                                                                                        : reminder.CustomerMobileNumber)
                                            </p>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    @reminder.ReminderDateTime.ToLocalTime().ToString("h:mm tt")
                                </td>
                                <td class="text-muted">@(!string.IsNullOrWhiteSpace(reminder.Note) ? reminder.Note : "No notes yet")</td>
                                <td class="text-end">
                                    <a asp-controller="FollowUp"
                                       asp-action="Add"
                                       asp-route-customerId="@reminder.CustomerId"
                                       class="btn btn-sm btn-outline-primary">
                                        Log follow-up
                                    </a>
                                </td>
                            </tr>
                                                        }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-light text-muted mb-0" role="alert">
                        No reminders scheduled for the rest of the day.
                    </div>
                }
            </div>
        </div>
    </div>
</div>
